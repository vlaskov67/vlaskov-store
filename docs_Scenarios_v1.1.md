# Подробные пользовательские сценарии «Vlaskov»

> **Версия:** 1.1  
> **Дата:** 21 апреля 2025 г.  
> **Связь с ТЗ:** дополнение к документу «Техническое задание (Версия 1.0)» — раздел 21.  
> **Правило фиксации:** любое согласованное изменение помечаем **#Decision**.

---

## Общая структура сценария
| Поле | Описание |
|------|----------|
| **ID** | Уникальный идентификатор (S‑###). |
| **Название** | Краткое описание задачи. |
| **Акторы** | Пользовательские роли, системы и сторонние сервисы. |
| **Предусловия** | Что должно быть выполнено до начала. |
| **Основной поток** | Шаги happy‑path. |
| **Альтернативы / ошибки** | Разветвления, ошибки и их обработка. |
| **Постусловия** | Результат выполнения. |
| **UI‑ссылки** | Макет из `/wireframes`, если есть. |

---

## S‑101. Первый визит и выбор региона
**Акторы:** Гость, GeoIP‑middleware, Cloudflare CDN  
**Предусловия:** Пользователь впервые заходит на `vlaskov.com`, cookie `region_override` отсутствует.  
**Основной поток:**
1. GeoIP определяет страну пользователя.
2. Middleware проверяет `?noredirect` — отсутствует.
3. Выводится баннер «Выберите регион» с кнопками CH, UK, EU, US.
4. Пользователь кликает, напр. **CH**.
5. JS → `setCookie(region_override=CH, 30d)`.
6. Frontend выполняет `window.location.replace('https://vlaskov.ch')`.
7. CDN обслуживает редирект‑страницу < 30 мс.
**Альтернативы / ошибки:**  
A1. Пользователь нажимает «×» → баннер скрывается до перезагрузки, регион по умолчанию INTL.  
A2. Параметр `?noredirect=1` → баннер не показывается, остаётся INTL.  
**Постусловия:** Установлен cookie, пользователь видит домашнюю страницу региона.  
**UI‑ссылки:** `/wireframes/region-select.png`.

---

## S‑102. Навигация по каталогу и выбор варианта товара
**Акторы:** Гость/Пользователь, Livewire `CatalogComponent`, MySQL, CDN  
**Предусловия:** Пользователь на странице категории, модель не выбрана.  
**Основной поток:**
1. Пользователь открывает селектор «Модель» — видит полный список.
2. Начинает печатать «iPhone 15» → Livewire фильтрует список (debounce 250 мс).
3. Выбирает модель → на сервер отправляется `model_id`, возвращается JSON список SKU.
4. Под селектором отображаются карточки всех цветов модели.
5. Пользователь наводит курсор на кружок цвета → JS меняет `src` картинки на URL превью.
6. Курсор уходит → изображение возвращается к дефолту.
7. Пользователь кликает по кружку цвета → открывается Livewire‑модалка `VariantModal`.
8. Модалка загружает галерею WebP (lazy).  
9. Пользователь нажимает «Добавить в корзину».  
10. Компонент «CartBadge» обновляет счётчик позиций.  
**Альтернативы / ошибки:**  
A1. Нет в наличии → кнопка disabled, появляется «Уведомить о поступлении».  
A2. Ошибка сети при загрузке SKU → Toast «Не удалось загрузить варианты».  
**Постусловия:** SKU добавлен в `cart_items` (guest session).  
**UI‑ссылки:** `/wireframes/catalog-flow/`.

---

## S‑103. Просмотр товара и cross‑sell
**Акторы:** Пользователь, Recommendation Service  
**Предусловия:** SKU выбран (из S‑102).  
**Основной поток:**
1. Модалка запрашивает `/api/recommendations?sku=…`.
2. Сервис возвращает JSON 4‑6 товаров.
3. Блок «Часто берут вместе» отображается под ценой.
4. Пользователь кликает на рекомендацию → открывается новая модалка.
**Альтернативы / ошибки:**  
A1. API timeout > 300 мс → блок скрыт.  
**Постусловия:** Пользователь может добавить рекомендуемый товар в корзину.  
**UI‑ссылки:** `/wireframes/product-modal.png`.

---

## S‑104. Корзина и оформление заказа (Guest Checkout)
**Акторы:** Гость, Stripe API, Twilio, Fixer.io  
**Предусловия:** В корзине ≥ 1 SKU.  
**Основной поток:**
1. Пользователь нажимает «Корзина» (иконка в шапке).  
2. Открывается Livewire‑модалка `CartDrawer` со списком позиций.
3. Нажимает «Оформить» — маршрут `/checkout` (guest).  
4. Checkout Step 1: ввод e‑mail + телефон. reCAPTCHA v2 → Verify.
5. Сервис `AuthService::sendOtp` отправляет SMS и email‑код (Twilio/SendGrid).  
6. Проверка OTP → success.
7. Step 2: адрес доставки, валидатор Post‑Code API (per region).  
8. Step 3: платёж — Stripe Elements (и региональные методы).  
9. `Stripe.createPaymentIntent(capture_method=automatic)`.  
10. Success → redirect `/thank‑you`.
11. Backend создает `order` + `order_items`, status `paid`.
12. Cron (15 мин) начинает трекинг Ship24.  
13. SendGrid отправляет «Спасибо за заказ», Twilio — SMS с номером.
**Альтернативы / ошибки:**  
A1. OTP неверен → 2 попытки, затем lock 5 мин.  
A2. Stripe 3‑DS ошибка → показывается причина, Step 3 остаётся активным.  
A3. Валюта региона изменилась (Fixer FX update) → UI пересчитает сумму перед Step 3.  
**Постусловия:** Заказ создан, пользователь получил подтверждение.  
**UI‑ссылки:** `/wireframes/checkout/`.

---

## S‑105. Регистрация и вход
**Акторы:** Гость, AuthService, Twilio  
**Предусловия:** Нет сессии, пользователь нажал «Войти / Регистрация».  
**Основной поток (Регистрация):**
1. В модалке таб «Регистрация». Поля: имя, e‑mail, телефон, пароль.
2. reCAPTCHA v2 pass.
3. Сервер создаёт `users` (status pending).
4. Отправляет SMS код.
5. Ввод кода → success → status active.
6. Сессия авторизована, redirect на `/account`.
**Вход:** email + пароль, rate‑limit 5/15 мин.  
**Альтернативы / ошибки:**  
A1. Неверный пароль → показ счётчика оставшихся попыток.  
A2. Забыли пароль → S‑106.  
**Постусловия:** Пользователь вошёл, токен JWT сохранён.  
**UI‑ссылки:** `/wireframes/auth-modal.png`.

---

## S‑106. Восстановление пароля
**Акторы:** Пользователь, SendGrid.  
**Предусловия:** Нажат «Забыли пароль?».  
**Основной поток:**
1. Поле e‑mail, reCAPTCHA v2.
2. Сервер генерирует `password_reset_token` (TTL = 60 мин).
3. SendGrid отправляет ссылку `https://vlaskov.{region}/reset?token=…`.
4. Пользователь открывает форму, вводит новый пароль.
5. Токен валидируется, пароль хэшируется (`Argon2id`).  
6. Показ уведомления «Пароль изменён».
**Постусловия:** Пользователь может войти новым паролем.

---

## S‑107. Личный кабинет — трекинг заказа
**Акторы:** Пользователь, Ship24, OrderService  
**Предусловия:** Пользователь авторизован, есть оплаченный заказ.  
**Основной поток:**
1. `/account/orders` запрашивает список `orders` по `user_id`.
2. Пользователь жмёт «Отследить».  
3. AJAX / Livewire вызывает `/orders/{id}/track`.
4. Backend проверяет кэш `shipment_events` (< 10 мин) → отдаёт данные.
5. Отображается временная шкала статусов.  
**Альтернативы / ошибки:**  
A1. `shipment_events` пуст → кнопка «Обновить» вызывает Ship24 Sync.  
**Постусловия:** Актуальные статусы показаны.

---

## S‑108. Запрос возврата товара
**Акторы:** Пользователь, Support‑оператор, Stripe API  
**Предусловия:** Статус заказа `delivered`.  
**Основной поток:**
1. Пользователь в деталях заказа нажимает «Запросить возврат».
2. Форма: причина, фото (opt), комментарий.
3. Создаётся `return_request` (status requested).
4. В админке оператор меняет статус → `approved`.
5. Пользователь получает email / SMS инструкции.
6. Товар приходит на склад, оператор меняет статус → `completed`.
7. Backend вызывает `Stripe.refund` (partial/full).  
**Альтернативы / ошибки:**  
A1. Фото > 5 MB → validation error.  
A2. Статус `delivered` < 14 дней → запрещено, сообщение об истечении срока.  
**Постусловия:** Средства возвращены, статус обновлён.

---

## S‑109. Применение промокода
**Акторы:** Пользователь, CouponService  
**Основной поток:**
1. В Step 3 checkout вводится код.
2. Livewire `validateCoupon` проверяет `coupons` (active, region, date).
3. Высчитывает скидку, обновляет totals.
**Альтернативы / ошибки:** code inactive, limit_reached → сообщение.
**Постусловия:** Скидка применяется, запись в `coupon_redemptions`.

---

## S‑110. Взаимодействие с чат‑ботом
**Акторы:** Гость/Пользователь, OpenAI API, Support‑оператор  
**Основной поток (FAQ):**
1. Виджет greeting на языке браузера.
2. Пользователь задаёт вопрос, отправляется `/chat_sessions`.
3. Backend формирует system‑prompt (по языку) + 10 контекст.
4. OpenAI API `/v1/chat/completions`.
5. Ответ стримится в виджет.
6. После 3× «I don’t know» → предложение «Переключиться на оператора».  
7. При согласии создаётся ticket, оператор подключается (web‑socket).  
**Альтернативы / ошибки:**  
A1. Жалоба «bad service» → handover.  
A2. Rate‑limit OpenAI → fallback «Извините, перегрузка».  
**Постусловия:** Сессия хранится 30 дней, оператор может оставить internal‑note.

---

## S‑111. Админ — импорт каталога CSV
**Акторы:** Контент‑менеджер, S3 Storage  
**Основной поток:**
1. В админке «Каталог» → «Импорт CSV».
2. Загружается файл, валидация: max 5 MB, заголовки columns.
3. Laravel Job помещает файл в `s3://imports/{timestamp}.csv`.
4. Queue worker парсит строки, создает/обновляет `products`, `variants`.
5. Email с отчётом об ошибках (если > 0).  
**Постусловия:** Каталог обновлён.

---

## S‑112. Cron‑трекинг Ship24
**Акторы:** Scheduler, Ship24 API  
**Периодичность:** каждые 15 мин.  
**Шаги:**
1. Job `SyncShipmentsJob` выбирает `shipments` со статусом ≠ delivered.
2. Ship24 API `v1/trackings/{tracking_number}`.
3. Новые события сохраняются в `shipment_events`.
4. Если статус изменился → websockets push уведомление пользователю.

---

> **Конец списка сценариев v1.1**

